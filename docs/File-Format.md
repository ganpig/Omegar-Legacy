# 谱面相关文件格式

## 歌曲文件夹及歌曲压缩包（zip 格式，文件扩展名为 `.omgz`，z 代表 zip）

- 歌曲信息文件：`info.omgs`
- 歌曲音频：`music.ogg`
- 曲绘：`illustration.png`
- 谱面文件： `charts/(等级名称).omgc`

## 歌曲信息文件（文本格式，文件扩展名为 `.omgs`，s 代表 song）

- 前 3 行：3 个字符串，分别表示曲名、曲师、画师。
- 第 4 行：一个整数 $n$，表示谱面数量。
- 第 5 行起：$n$ 组谱面信息（每组谱面信息有 4 行，分别表示难度、定数、谱师、谱面文件 MD5 值）。

## 谱面文件（二进制格式，文件扩展名为 `.omgc`，c 代表 chart）

该文件由一个整数 $n$ 和 $n$ 个指令构成。

指令格式：时间（单位为 ms，-1 表示游戏前执行） + 类型 + 参数。

指令列表如下：

#### `0x01` 添加 note

- 参数 1：note 的 ID。
- 参数 2：note 的属性。
  - `0b1` （属性 1）
  - `0b10` （属性 2）
  - `0b100` （属性 3）
  - `0b1000` （属性 4）
- 参数 3~5：初始位置函数。
- 参数 6：初始显示轨道。
- 参数 7：实际判定轨道。
- 参数 8：开始时间。
- 参数 9：结束时间。
- 参数 10：显示长度。

#### `0x02` 更改 note 位置函数

- 参数 1：note 的 ID。
- 参数 2：二次项系数。
- 参数 3：一次项系数。
- 参数 4：常数项。

###### 备注

note 相对于判定线的位置关于时间的二次函数为 note 相对于判定线的速度关于时间的一次函数的不定积分。制谱器工程文件中存储了 $n$ 个形如 $(t_i,n_i)$ 的关键点，每相邻两点可确定该区间上的速度变化直线，对速度函数做不定积分即可计算出该区间上位置关于时间的二次函数。另外，需要取常数以使各段抛物线首尾顺次相接。

#### `0x03` 更改 note 轨道函数

- 参数 1：note 的 ID。
- 参数 2：目标轨道。
- 参数 3：目标时间。
- 参数 4：缓动类型。
  - `0x01` 直线缓动（$p=kt+b$）
    - 参数 5~6：$k$ 和 $b$ 的值。
    - （k=p2-p1 b=t2p1-t1p2）
  - `0x02` 正弦缓动（$p=Asin(\omega x+\varphi)+b$）
    - 参数 5~8：$A、\omega、\varphi、b$ 的值。
    - （A=(p1-p2)/2，ω=π/(p1-p2)，φ=ω(t1+t2)/2，b=(p1+p2)/2）

#### `0x04` 激活 note

- 参数 1：note 的 ID。

###### 备注

激活 note 即将 note 添加到活动 note 列表。绘制 note 和进行打击判定时，只遍历活动 note 列表中的 note。note 被打击或超时后，将 note 从活动 note 列表中移除。

#### `0x10` 更改判定线位置函数

- 参数 1：目标位置。
- 参数 2：目标时间。
- 参数 3：缓动类型。
  - `0x01` 直线缓动（$p=kt+b$）
    - 参数 4~5：$k$ 和 $b$ 的值。
  - `0x02` 正弦缓动（$p=Asin(\omega x+\varphi)+b$）
    - 参数 4~7：$A、\omega、\varphi、b$ 的值。
